version: '3.8'

services:
  # Primary Database (Writes go here)
  mysql-primary:
    image: mysql:8.0
    container_name: mysql-primary
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: appdb
    command: --default-authentication-plugin=mysql_native_password
    networks:
      - proxynet

  # Replica Database (Reads go here)
  mysql-replica:
    image: mysql:8.0
    container_name: mysql-replica
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: appdb
    command: --default-authentication-plugin=mysql_native_password
    networks:
      - proxynet

  # The Proxy
  proxysql:
    image: proxysql/proxysql:2.5.5
    container_name: proxysql
    ports:
      - "6032:6032" # Admin Port
      - "6033:6033" # Traffic Port
    networks:
      - proxynet
    depends_on:
      - mysql-primary
      - mysql-replica

networks:
  proxynet:
    driver: bridge